name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - dev
      - 'feature/*'
  pull_request:
    branches:
      - main

jobs:
  set-environment:
    runs-on: ubuntu-latest
    outputs:
      build_env: ${{ steps.set-env.outputs.build_env }}
    steps:
      - name: Determine BUILD_ENV
        id: set-env
        run: |
          case "${GITHUB_REF_NAME}" in
          main)
            echo "build_env=prod" >> $GITHUB_OUTPUT
            ;;
          dev)
            echo "build_env=dev" >> $GITHUB_OUTPUT
            ;;
          feature/*)
            echo "build_env=feature" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "build_env=other" >> $GITHUB_OUTPUT
            ;;
          esac
          echo "ğŸ” BUILD_ENV determined: $(cat $GITHUB_OUTPUT | grep build_env | cut -d'=' -f2)"

  ci:
    runs-on: ubuntu-latest
    needs: set-environment
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Grant execute permission
        run: chmod +x ./gradlew

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run tests with coverage
        run: ./gradlew clean test jacocoTestReport jacocoTestCoverageVerification


      - name: Jacoco Report Summary
        uses: madrapps/jacoco-report@v1.7.1
        with:
          paths: build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ§ª Test Coverage Report"
          update-comment: true
          min-coverage-overall: 30
          min-coverage-changed-files: 30
          skip-if-no-changes: false
          continue-on-error: true

      - name: Upload Jacoco HTML report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: build/reports/jacoco/test/html

      - name: Build JAR
        run: ./gradlew build

      - name: Build & Push Docker Image with Jib
        if: github.ref_name == 'main' || github.ref_name == 'dev'
        env:
          DOCKER_REGISTRY_URL: ${{ secrets.DOCKER_REGISTRY_URL }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          BUILD_ENV: ${{ needs.set-environment.outputs.build_env }}
        run: |
          echo "ğŸ³ Building and pushing Docker image with tag: ${BUILD_ENV}"
          ./gradlew jib

  cd:
    runs-on: ubuntu-latest
    needs: [ set-environment, ci ]
    if: github.ref_name == 'main' || github.ref_name == 'dev'
    steps:
      - name: Deploy to Synology NAS (Blue-Green)
        uses: appleboy/ssh-action@v1.0.3
        env:
          BUILD_ENV: ${{ needs.set-environment.outputs.build_env }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ›°ï¸  Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘..."
            BUILD_ENV="${{ needs.set-environment.outputs.build_env }}"
            echo "ğŸ“¦ Docker ì´ë¯¸ì§€ íƒœê·¸: ${BUILD_ENV}"

            # í™˜ê²½ë³„ ì„¤ì •
            if [ "${BUILD_ENV}" = "prod" ]; then
              CONTAINER_NAME="wedsnap-prod"
              HOST_PORT="8080"
              DOMAIN="wedsnap.agfe2.synology.me"
              VOLUME_PATH="/volume1/docker/wedsnap"
            elif [ "${BUILD_ENV}" = "dev" ]; then
              CONTAINER_NAME="wedsnap-dev"
              HOST_PORT="8081"
              DOMAIN="wedsnap-dev.agfe2.synology.me"
              VOLUME_PATH="/volume1/docker/wedsnap-dev"
            fi

            echo "ğŸ”§ í™˜ê²½: ${BUILD_ENV}"
            echo "ğŸ”Œ í¬íŠ¸: ${HOST_PORT}:8080"
            echo "ğŸŒ ë„ë©”ì¸: https://${DOMAIN}"
            echo "ğŸ’¾ ë³¼ë¥¨: ${VOLUME_PATH}"

            export PATH=$PATH:/usr/local/bin

            # Blue-Green ë°°í¬: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìƒ‰ìƒ í™•ì¸
            CURRENT_CONTAINER=$(docker ps --filter "name=${CONTAINER_NAME}" --format "{{.Names}}" 2>/dev/null | grep -E "${CONTAINER_NAME}-(blue|green)" | head -1)

            if [[ "$CURRENT_CONTAINER" == *"-blue" ]]; then
              NEW_COLOR="green"
              OLD_COLOR="blue"
              echo "ğŸ”µ í˜„ì¬ Blue ì‹¤í–‰ ì¤‘ â†’ Greenìœ¼ë¡œ ì „í™˜"
            else
              NEW_COLOR="blue"
              OLD_COLOR="green"
              echo "ğŸŸ¢ í˜„ì¬ Green ì‹¤í–‰ ì¤‘ (ë˜ëŠ” ì—†ìŒ) â†’ Blueë¡œ ì „í™˜"
            fi

            NEW_CONTAINER_NAME="${CONTAINER_NAME}-${NEW_COLOR}"
            OLD_CONTAINER_NAME="${CONTAINER_NAME}-${OLD_COLOR}"
            TEMP_PORT=$((HOST_PORT+100))

            echo "ğŸ“¦ ìƒˆ ì»¨í…Œì´ë„ˆ: ${NEW_CONTAINER_NAME}"
            echo "ğŸ—‘ï¸  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ: ${OLD_CONTAINER_NAME}"

            # ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker pull ${{ secrets.DOCKER_REGISTRY_URL }}/wedsnap:${BUILD_ENV}

            # ê¸°ì¡´ ê°™ì€ ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì¤‘ë³µ ë°©ì§€)
            docker rm -f ${NEW_CONTAINER_NAME} 2>/dev/null || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ (ì„ì‹œ í¬íŠ¸ë¡œ)
            echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘ (ì„ì‹œ í¬íŠ¸: ${TEMP_PORT})..."
            docker run -d \
              --name ${NEW_CONTAINER_NAME} \
              -p ${TEMP_PORT}:8080 \
              -v ${VOLUME_PATH}:/nas/wedsnap \
              -e "SPRING_PROFILES_ACTIVE=${BUILD_ENV}" \
              ${{ secrets.DOCKER_REGISTRY_URL }}/wedsnap:${BUILD_ENV}

            # í—¬ìŠ¤ì²´í¬ (ì‹¤ì œ HTTP ìš”ì²­ìœ¼ë¡œ ê²€ì¦)
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
            HEALTH_CHECK_PASSED=false

            for i in {1..10}; do
              echo "  ì‹œë„ ${i}/10..."

              # Spring Boot Actuator health ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
              if curl -f -s http://localhost:${TEMP_PORT}/actuator/health > /dev/null 2>&1; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤"
                HEALTH_CHECK_PASSED=true
                break
              fi

              # ì»¨í…Œì´ë„ˆê°€ ì¤‘ì§€ë˜ì—ˆëŠ”ì§€ í™•ì¸
              if ! docker ps | grep -q ${NEW_CONTAINER_NAME}; then
                echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤"
                break
              fi

              sleep 3
            done

            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
            if [ "$HEALTH_CHECK_PASSED" != "true" ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ë°°í¬ë¥¼ ë¡¤ë°±í•©ë‹ˆë‹¤"
              echo "ğŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
              docker logs --tail 50 ${NEW_CONTAINER_NAME}

              echo "ğŸ”„ ìƒˆ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
              docker stop ${NEW_CONTAINER_NAME} 2>/dev/null || true
              docker rm ${NEW_CONTAINER_NAME} 2>/dev/null || true

              echo "âš ï¸  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ(${OLD_CONTAINER_NAME})ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤"
              exit 1
            fi

            # íŠ¸ë˜í”½ ì „í™˜: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "ğŸ”„ íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
            if docker ps | grep -q ${OLD_CONTAINER_NAME}; then
              echo "ğŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ(${OLD_COLOR}) ì¤‘ì§€ ì¤‘..."
              docker stop -t 30 ${OLD_CONTAINER_NAME} 2>/dev/null || true
            fi

            # ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤ì œ í¬íŠ¸ë¡œ ì¬ì‹œì‘
            echo "ğŸ”Œ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤ì œ í¬íŠ¸(${HOST_PORT})ë¡œ ì¬ì‹œì‘ ì¤‘..."
            docker stop ${NEW_CONTAINER_NAME}
            docker rm ${NEW_CONTAINER_NAME}

            docker run -d \
              --name ${NEW_CONTAINER_NAME} \
              -p ${HOST_PORT}:8080 \
              -v ${VOLUME_PATH}:/nas/wedsnap \
              -e "SPRING_PROFILES_ACTIVE=${BUILD_ENV}" \
              -e APP_VERSION=1.0.1 \
              ${{ secrets.DOCKER_REGISTRY_URL }}/wedsnap:${BUILD_ENV}

            # ìµœì¢… í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ ìµœì¢… í—¬ìŠ¤ì²´í¬ ì¤‘..."
            sleep 3

            if curl -f -s http://localhost:${HOST_PORT}/actuator/health > /dev/null 2>&1; then
              echo "âœ… ìµœì¢… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"

              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
              if docker ps -a | grep -q ${OLD_CONTAINER_NAME}; then
                echo "ğŸ—‘ï¸  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ(${OLD_COLOR}) ì‚­ì œ ì¤‘..."
                docker rm ${OLD_CONTAINER_NAME} 2>/dev/null || true
              fi

              echo "âœ… Blue-Green ë°°í¬ ì™„ë£Œ!"
              echo "âœ… ì ‘ì† URL: https://${DOMAIN}"
              echo "ğŸ¨ í™œì„± ì»¨í…Œì´ë„ˆ: ${NEW_COLOR} (${NEW_CONTAINER_NAME})"
            else
              echo "âŒ ìµœì¢… í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ê¸´ê¸‰ ë¡¤ë°± ì‹œë„"

              # ê¸´ê¸‰ ë¡¤ë°±: ìƒˆ ì»¨í…Œì´ë„ˆ ì¤‘ì§€í•˜ê³  ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
              docker stop ${NEW_CONTAINER_NAME} 2>/dev/null || true
              docker rm ${NEW_CONTAINER_NAME} 2>/dev/null || true

              if docker ps -a | grep -q ${OLD_CONTAINER_NAME}; then
                echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ(${OLD_COLOR}) ì¬ì‹œì‘ ì¤‘..."
                docker start ${OLD_CONTAINER_NAME}
                echo "âš ï¸  ë¡¤ë°± ì™„ë£Œ: ê¸°ì¡´ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤"
              else
                echo "âŒ ë¡¤ë°± ì‹¤íŒ¨: ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              fi

              exit 1
            fi

  notify:
    runs-on: ubuntu-latest
    needs: [ ci, cd ]
    if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ìƒê´€ì—†ì´ í•­ìƒ ì‹¤í–‰
    steps:
      - name: Send Slack notification (success or failure)
        run: |
          # Job ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
          CI_RESULT="${{ needs.ci.result }}"
          CD_RESULT="${{ needs.cd.result }}"

          # ìƒíƒœì— ë”°ë¼ ë©”ì‹œì§€ ê²°ì •
          if [[ "$CI_RESULT" == "failure" || "$CD_RESULT" == "failure" ]]; then
            STATUS="âŒ ì‹¤íŒ¨"
            COLOR="#FF4C4C"
          else
            STATUS="âœ… ì„±ê³µ"
            COLOR="#36A64F"
          fi

          # ì‹¤íŒ¨í•œ Job í‘œì‹œ
          FAILED_JOBS=""
          if [[ "$CI_RESULT" == "failure" ]]; then
            FAILED_JOBS="${FAILED_JOBS} CI "
          fi
          if [[ "$CD_RESULT" == "failure" ]]; then
            FAILED_JOBS="${FAILED_JOBS} CD "
          fi

          # Slack ë©”ì‹œì§€ ë³¸ë¬¸
          MESSAGE="{
            \"attachments\": [
              {
                \"color\": \"${COLOR}\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*${STATUS} | GitHub Actions ì•Œë¦¼*\n\nâ€¢ Repository: *${{ github.repository }}*\nâ€¢ Branch: *${{ github.ref_name }}*\nâ€¢ ì‹¤í–‰ì: *${{ github.actor }}*\nâ€¢ ì‹¤í–‰ ë§í¬: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Run ë³´ê¸°>\"
                    }
                  },
                  {
                    \"type\": \"context\",
                    \"elements\": [
                      {
                        \"type\": \"mrkdwn\",
                        \"text\": \"ì‹¤íŒ¨í•œ Job: *${FAILED_JOBS:-ì—†ìŒ}* | CI: ${CI_RESULT} / CD: ${CD_RESULT}\"
                      }
                    ]
                  }
                ]
              }
            ]
          }"

          echo "ğŸ“¤ Sending Slack message..."
          curl -X POST -H 'Content-type: application/json' \
            --data "${MESSAGE}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
